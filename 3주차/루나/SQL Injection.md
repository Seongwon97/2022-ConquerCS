## SQL Injection이란?

> 해커에 의해 조작된 SQL 쿼리문이 데이터베이스에 그대로 전달되어 비정상적 명령을 실행시키는 공격 기법
>
- 웹 애플리케이션이 백엔드에서 구동 중인 데이터베이스에 질의를 하는 과정에 사용되는 SQL 쿼리를 조작하여 데이터베이스를 대상으로 공격자가 의도한 악의적인 행위를 할 수 있는 Injection 기반의 웹 취약점
- 공격에 성공하게 되면 조직 내부의 민감한 데이터나 개인 정보를 획득할 수 있으며, 심각한 경우에는 조직의 데이터 전체를 장악하거나 완전히 손상시킬 수 있다.

## **공격 방법**

### **인증 우회**

> SQL 인젝션 공격의 대표적인 경우로, 로그인 폼(Form)을 대상으로 공격을 수행한다. 정상적인 계정 정보 없이도 로그인을 우회하여 인증을 획득할 수 있다.
>

**예시 1**

아이디와 비밀번호를 input 창에 입력할 때, 아이디가 abc, 비밀번호가 1234일 때, 쿼리는 아래와 같이 전송된다.

`SELECT * FROM USER WHERE ID = "abc" AND PASSWORD = "1234";`

SQL Injection으로 공격할 때, input 창에 비밀번호를 입력함과 동시에 다른 쿼리문을 함께 입력하는 것이다.

`1234; DELETE * USER FROM ID = "1";`

보안이 완벽하지 않은 경우, 이처럼 **비밀번호가 아이디와 일치해서 True가 되고** 뒤에 작성한 DELETE 문도 데이터베이스에 영향을 줄 수도 있게 되는 치명적인 상황이다.

**예시 2**

기본 쿼리문의 WHERE 절에 OR문을 추가하여 '1' = '1'과 같은 true문을 작성하여 무조건 적용되도록 수정한 뒤 DB를 마음대로 조작할 수도 있다.

`select * from client where name='anjinma' and password=' or '1'='1'`

### **데이터 노출**

시스템에서 발생하는 에러 메시지를 이용해 공격하는 방법이다. 보통 에러는 개발자가 버그를 수정하는 면에서 도움을 받을 수 있는 존재다. 해커들은 이를 역이용해 악의적인 구문을 삽입하여 에러를 유발시킨다.

**예시**

해커는 **GET 방식으로 동작하는 URL 쿼리 스트링을 추가하여 에러를 발생**시킨다. 이에 해당하는 오류가 발생하면, 이를 통해 **해당 웹앱의 데이터베이스 구조를 유추**할 수 있고 해킹에 활용한다.

url을 통해 파라미터를 주고받는 GET 방식은 해커가 단순히 url을 통해 전달될 파라미터를 조작하기만 한다면 손쉽게 SQL injection 취약점을 적용할 수 있다.

- URL 쿼리 스트링 : 사용자가 입력 데이터를 전달하는 방법중의 하나로, url 주소에 미리 협의된 데이터를 파라미터를 통해 넘기는 것`http://test.com/login.php?id=abc1234 and password=''`

## **방어 방법**

### **input 값을 받을 때, 특수문자 여부 검사하기**

사용자의 입력 값에 대한 검증 진행

- 서버단에서 화이트 리스트 기반으로 검증하는 것이 좋다.
    - 블랙리스트 기반으로 검증하게 되면 수많은 차단리스트를 등록해야 하고, 하나라도 빠지면 공격에 성공하게 되기 때문!
- 공백으로 치환하는 방법도 많이 쓰이는데, 이 방법도 취약한 방법이다.
    - 예를 들어 공격자가 SESELECTLECT 라고 입력 시 중간의 SELECT가 공백으로 치환이 되면 SELECT 라는 키워드가 완성되게 된다.

      ⇒ 공백 대신 공격 키워드와는 의미 없는 단어로 치환되어야 한다.


### **SQL 서버 오류 발생 시, 해당하는 에러 메시지 감추기**

일반 사용자는 view로만 접근하여 에러를 볼 수 없도록 한다.

- 공격자가 SQL Injection을 수행하기 위해서는 데이터베이스의 정보(테이블명, 컬럼명 등)가 필요하다.
    - 데이터베이스 에러 발생 시 따로 처리를 해주지 않았다면, 에러가 발생한 쿼리문과 함께 **에러에 관한 내용을 반환**해준다. 여기서 **테이블명 및 컬럼명 그리고 쿼리문이 노출**이 될 수 있다!
- 원본 데이터베이스 테이블에는 접근권한을 높여, 일반 사용자에게는 데이터 베이스에 대한 오류발생 시 사용자에게 보여줄 수 있는 페이지를 제작 혹은 메시지박스를 띄우도록 하여야 한다.

### **preparestatement 사용하기**

`INSERT INTO MyGuests VALUES(?, ?, ?)`

Prepared Statement 구문을 사용하게 되면, 사용자의 입력 값이 데이터베이스의 파라미터로 들어가기 전에DBMS가 미리 컴파일 하여 실행하지 않고 대기한다.

- 그 후 사용자의 입력 값을 문자열로 인식하게 하여 공격쿼리가 들어간다고 하더라도, 사용자의 입력은 이미 의미 없는 단순 문자열 이기 때문에 전체 쿼리문도 공격자의 의도대로 작동하지 않는다.
- statement와는 다르게 쿼리문에서 전달인자값을 ?로 받게 된다.
- JPA에서도 value로 들어가기 때문에 SQL Injection으로부터 안전하다.!
    - Spring Data JPA에서 제공하는 API(save(), saveAll() 등의)를 활용하게 된다면 SQL 인젝션에 대한 고민은 거의 하지 않게될 것이다. 내부적으로 이미 **Parameter Binding**을 활용하고 있다고 공식적으로 이야기하고 있기 때문인데.. 하지만 위험한 길은 있기 마련이다.
    - 예컨데 SQL 쿼리 스트링을 직접 짜서 entityManager에 전달한다던가 이런식의 JPA 활용은 다소 위험을 유발할 수 있다.

### **웹 방화벽 사용**

웹 공격 방어에 특화되어있는 웹 방화벽을 사용하는 것도 하나의 방법이다.

- 웹 방화벽의 종류
    - 소프트웨어 형 : 서버 내에 직접 설치하는 방법
    - 하드웨어 형 : 네트워크 상에서 서버 앞 단에 직접 하드웨어 장비로 구성하는 것
    - 프록시 형 : DNS 서버 주소를 웹 방화벽으로 바꾸고 서버로 가는 트래픽이 웹 방화벽을 먼저 거치도록 하는 방법
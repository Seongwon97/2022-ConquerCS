# SQL Injection
SQL Injection이란 악의적인 사용자가 보안상의 취약점을 이용하여 임의의 SQL문을 주입하고 실행하게 하여 데이터베이스가 비정상적인 동작을 하도록 조작하는 공격을 말한다. 인젝션 공격은 OWASP(오픈소스 보안 프로젝트) Top10 중 첫 번째에 속해 있으며, 공격이 비교적 쉬운 편이고 공격에 성공할 경우 큰 피해를 입힐 수 있는 공격이다.

## 공격 종류

### **Error based SQL Injection (**논리적 에러를 이용한 SQL Injection)

![Untitled](./img/error%20based%20SQL%20Injection.png)

- 가장 많이 쓰이는 대중적인 SQL Injection 공격 기법이다.
- 사진을 보면 1 번은 일반적인 쿼리문인 것을 알 수 있다. 해당 쿼리에서 입력값에 대한 검증이 없다는 것을 확인하고 악의적인 사용자가 ``OR 1=1 --` 이라는 내용을 주입시키면 WHERE 절이 모두 참이 되고 `--` 를 통해 뒤의 구문들이 주석처리가 되게 된다. 이와 같이 간단한 구문 삽입을 통해 User 테이블에 있는 모든 정보를 조회하게 됨으로써 가장 먼저 만들어진 계정으로 로그인이 가능하게 된다.

### **Union based SQL Injection**

정상적인 쿼리문에 Union 키워드를 사용하여 인젝션에 성공하면, 원하는 쿼리문을 실행할 수 있게 된다.

> Union Injection을 성공하기 위해서는 Union을 할 두 테이브르이 컬럼과 데이터형이 같아야한다는 조건이 있다.
>

![Untitled](./img/union%20based%20SQL%20Injection.png)

- 위의 1번 쿼리는 title 과 contents 컬럼의 데이터랑 비교한 뒤 비슷한 글자가 있는 게시글을 출력하는 게시글 검색 쿼리이다.  여기서 입력값으로 Union 키워드와 함께 컬럼 수를 맞춰서 SELECT 구문을 넣어주게 되면 두 쿼리문이 합쳐서서 하나의 테이블로 보여지게 된다. 현재 인젝션 한 구문은 사용자의 id와 passwd를 요청하는 쿼리문 입니다. 인젝션이 성공하게 되면, 사용자의 개인정보가 게시글과 함께 화면에 보여지게 된다.

### **Blind SQL Injection**

- **Boolean based SQL**

  데이터베이스로부터 특정한 값이나 데이터를 전달받지 않고 단순히 참가 거짓의 정보만 알 수 있을 때 할 수 있는 공격이다. 로그인 폼에 SQL Injection이 가능하다고 가정 했을 때, 서버가 응답하는 로그인 성공과 로그인 실패 메시지를 이용하여, DB의 테이블 정보 등을 추출해 낼 수 있다.

- **Time based SQL**

  MySQL 기준으로 SLEEP 과 BENCHMARK의 함수를 사용해 서버로부터 특정한 응답 대신에 참 혹은 거짓의 응답을 통해 데이터베이스의 정보를 유추하는 기법이다.


### **Stored Procedure SQL Injection**

저장 프로시저는 일련의 쿼리들을 모아 하나의 함수처럼 사용하기 위한 것이다. 해당 공격은 저장 프로세저에서 SQL 인젝션을 하는 공격으로 공격자가 시스템 권한을 획득해야 할 수 있는 공격이라 난의도가 높다.

### Mass SQL Injection

2008년에 처음 발견된 공격기법으로 기존 SQL Injection 과 달리 한번의 공격으로 다량의 데이터베이스가 조작되어 큰 피해를 입히는 것을 의미한다. 보통 MS-SQL을 사용하는 ASP 기반 웹 애플리케이션에서 많이 사용되며, 쿼리문은 HEX 인코딩 방식으로 인코딩 하여 공격한다. 보통 데이터베이스 값을 변조하여 데이터베이스에 악성스크립트를 삽입하고, 사용자들이 변조된 사이트에 접속 시 좀비PC로 감염되게 한다. 이렇게 감염된 좀비 PC들은 DDoS 공격에 사용된다.

## 대응 방안

1. **입력값에 대한 검증**
    - 서버단에서 화이트리스트 기반으로 사용자의 입력 값을 검증해야 한다.
    - 특수문자 여부를 검증해 요청을 막아낸다.
2. **Prepared Statement 구문 사용**

   Prepared Statement 구문을 사용하게 되면, 사용자의 입력 값이 데이터베이스의 파라미터로 들어가기 전에DBMS가 미리 컴파일 하여 실행하지 않고 대기한다. 그 후 사용자의 입력 값을 문자열로 인식하게 하여 공격쿼리가 들어간다고 하더라도, 사용자의 입력은 이미 의미 없는 단순 문자열 이기 때문에 전체 쿼리문도 공격자의 의도대로 작동하지 않는다.

3. **Error Message 노출 금지**
4. **웹 방화벽 사용**

- Q. 입력값에 대한 검증을 통해 대응을 할 때, 왜 블랙리스트 기반이 아닌 화이트 리스트 기반으로 검증해야할까?
    - A. 블랙리스트 기반으로 검증하게 되면 수많은 차단리스트를 등록해야 하고, 하나라도 빠지면 공격에 성공하게 되기 때문입니다.

[SQL Injection 이란? (SQL 삽입 공격)](https://noirstar.tistory.com/264)

# 대규모 트래픽에 대처할 수 있는 방법

요즘 시대에는 웹사이트에 접속하는 인원이 급격히 늘어나게 되었다. 이 상황에서 서버가 단 하나만 존재할 때, 수천만 명의 사람들이 서버에 동시 접속하면 어떻게 될까? 하나의 서버는 부하를 감당하지 못할 수도 있을 것이다.

### 문제 해결의 방식

- `Scale-up` : Server가 더 빠르게 동작하기 위해 하드웨어 성능을 올리는 방법.
- `Scale-out` : 하나의 Server 보다는 여러 대의 Server가 나눠서 일을 하는 방법.

### **Scale-out의 장점**

- 하드웨어 향상하는 비용보다 서버 한대 추가 비용이 더 적다.
- 여러 대의 Server 덕분에 무중단 서비스를 제공할 수 있다.

대부분의 서비스는 서버의 성능을 높이는 Scale-up 작업은 한계가 있으므로 분산 처리를 위해 여러 대의 서버를 두는 Scale-out 작업을 하게 되는데, 이때 여러 서버들로 대규모의 네트워크 트래픽을 분산 처리하는 기술을 로드 밸런싱(Load Balancing)이라고 한다.

# 로드밸런싱

> 네트워크 또는 서버에 가해지는 부하를 분산하기 위해 둘 이상의 CPU or 저장장치와 같은 컴퓨터 자원들에게 작업을 나누는 것
>

![.](https://camo.githubusercontent.com/b59f02d63a1372b35abffa94e241b9b8d27447f3/68747470733a2f2f7777772e6564756361746976652e696f2f6170692f636f6c6c656374696f6e2f353636383633393130313431393532302f353634393035303232353334343531322f706167652f353734373937363230373037333238302f696d6167652f353639363435393134383039393538342e706e67)

**로드 밸런싱**은 분산식 웹 서비스로, 여러 서버에 부하(Load)를 나누어주는 역할을 한다. Load Balancer를 클라이언트와 서버 사이에 두고, 부하가 일어나지 않도록 여러 서버에 분산시켜주는 방식이다. 서비스를 운영하는 사이트의 규모에 따라 웹 서버를 추가로 증설하면서 로드 밸런서로 관리해주면 웹 서버의 부하를 해결할 수 있다.

# 로드 밸런서

> 로드 밸런싱 기술을 제공하는 서비스 또는 장치
>

클라이언트와 네트워크 트래픽이 집중되는 서버들 사이에 위치하며 VIP(Virtual IP)와 함께 구성된다. 또한, 특정 서버에 부하가 집중되지 않도록 트래픽을 다양한 방법으로 분산하여 서버들의 성능을 최적인 상태로 유지할 수 있도록 한다.

<aside>
💡 VIP란?
VIP란 로드 밸런싱의 대상이 되는 여러 서버를 대표하는 가상의 아이피다. 클라이언트들은 서버의 IP로 직접 요청을 하는 것이 아니라 LB가 가지고 있는 VIP를 대상으로 요청한다. 그리고 LB는 설정된 부하 분산 방법에 따라 각 서버로 요청을 분산시킨다.

</aside>

## 로드밸런서 기본 기능

### **1. 상태 확인 (Health Check)**

로드 밸런서는 서버들에 대한 주기적인 상태 확인(Health Check)을 통해 서버들의 장애 여부를 판단할 수 있다. 이로 인해, 서버에 이상이 생기면 정상적으로 동작하는 서버로 트래픽을 보내주는 Fail-over가 가능하며, 또한 TCP/UDP 분석이 가능하기 때문에 방화벽(Firewall)의 역할도 수행할 수 있다.

- L3 체크 : ICMP를 이용해 서버의 IP 주소가 통신 가능한 상태인지 확인한다.
- L4 체크 : TCP의 3-way handshaking을 통해 각 서버의 포트 상태를 확인한다.
- L7 체크 : 애플리케이션 계층에서 체크하는 방법으로 실제 웹 페이지에 통신을 시도해 이상 유무를 파악한다.

### **2. Tunneling**

터널링(Tunneling)은 인터넷상에서 눈에 보이지 않는 통로를 만들어 통신할 수 있게 하는 개념이다. 데이터를 캡슐화해서 연결된 상호 간에만 캡슐화된 패킷을 구별해 캡슐화를 해제할 수 있다.

로드 밸런서의 VIP 주소로 향하는 요구 패킷이 로드 밸런싱 서버로 전달되면 로드 밸런싱 서버에서 패킷의 목적지 주소와 포트를 검사하여 가상 서버 정책과 일치할 경우, 스케줄링에 따라 실제 작업 서버로 전달하게 된다. 이때 패킷을 일반적인 스트림(Stream) 방식으로 전달하는 것이 아닌 캡슐 형식으로 싸서 전달하게 된다. 이렇게 전달되면 작업 서버에서는 감싸진 패킷을 다시 풀고 요청을 처리한다.

### **3. NAT (Network Address Translation)**

IP 주소를 변환해주는 기능이다. 예를 들어, 내부 네트워크에서 사용하던 사설 IP 주소를 로드 밸런서 외부의 공인 IP 주소로 변경해준다(반대로도 가능). 이렇게 하면 부족한 공인 IP 주소를 효율적으로 사용할 수 있지만, 로드 밸런싱 관점에서는 여러 개의 호스트가 하나의 공인 IP 주소(VIP)를 통해 접속하는 것이 주목적이다.

- SNAT (Source Network Address Translation)
  - 내부에서 외부로 트래픽이 나가는 경우, 내부 사설 IP 주소를 외부 공인 IP 주소로 변환하는 방식이다. 집에서 사용하는 공유기가 대표적인 예이다.
- DNAT (Destionation Network Address Translation)
  - 외부에서 내부로 트래픽이 들어오는 경우, 외부 공인 IP 주소를 내부의 사설 IP 주소로 변환하는 방식이다.

![https://user-images.githubusercontent.com/55661631/145209004-e86753b1-23c7-4882-bfbf-deb589db1a19.png](https://user-images.githubusercontent.com/55661631/145209004-e86753b1-23c7-4882-bfbf-deb589db1a19.png)

### **4. DSR (Direct Server Routing)**

서버에서 클라이언트로 되돌아가는 경우, 목적지를 클라이언트로 설정한 다음 네트워크 장비나 로드밸런서를 거치지 않고 바로 클라이언트로 찾아가는 방식이다. 이 경우, 로드밸런서의 부하를 줄여줄 수 있는 장점이 있다.

## 로드밸런서의 종류

로드밸런서는 OSI 7 계층을 기준으로 어떻게 부하를 분산하는지에 따라 종류가 나뉜다. 2 계층을 기준으로 부하를 분산한다면 L2, 3 계층을 기준으로 분산한다면 L3인 방식이다. 상위 계층으로 갈수록 섬세한 부하 분산이 가능하지만, 가격과 성능에 드는 비용이 증가한다.

부하 분산에는 L4 로드밸런서과 L7 로드밸런서가 가장 많이 활용된다. 그 이유는 L4부터 포트(Port) 정보를 바탕으로 분산하는 것이 가능하기 때문이다. 한 대의 서버에 각각 다른 포트 번호를 부여하여 다수의 서버 프로그램을 운영하는 경우라면 최소 L4 이상을 사용해야 한다.

![Untitled](https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F955bcd3f-8655-4d4a-bc63-07f7f44b0ae5%2FUntitled.png?table=block&id=dc11b4a3-d4c9-4080-acaa-1bae74395e90&spaceId=ae7599b2-a6a0-4ad1-9149-e9ef3a1ab56c&width=1930&userId=1283b1b0-5fc9-41f0-9b53-56b46ea4c788&cache=v2)

## 로드 밸런서 동작 방식 (L4 기준)

대부분의 로드 밸런서는 아래와 같은 절차로 동작한다.

![https://user-images.githubusercontent.com/55661631/145208882-7a6e7245-012b-4df1-bad3-aca65c22ffe3.png](https://user-images.githubusercontent.com/55661631/145208882-7a6e7245-012b-4df1-bad3-aca65c22ffe3.png)

1. 클라이언트가 브라우저에서 www.google.com이라고 입력하면 PC에 설정된 DNS 서버로 DNS Query를 보내고, Local DNS 서버는 www.google.com을 관리하는 DNS 서버부터 L4의 VIP 주소를 획득한다.
2. Local DNS는 획득한 VIP 주소를 클라이언트에게 전송한다.
3. 클라이언트는 획득한 DNS를 기반으로 L4 VIP로 http(s) 요청을 한다.
4. LB는 최적의 서비스 서버를 내부 알고리즘을 통하여 선별한 후 요청을 전송하고, 서버 작업 결과를 LB에게 전송한다.
5. 전달받은 결과를 LB를 통해 클라이언트에게 전송한다.

## **로드 밸런서의 로드밸런싱 방법들**

### L4 로드밸런서

- 라운드 로빈(Round Robin)
  - CPU 스케줄링의 라운드 로빈 방식 활용
  - 요청이 들어오는 대로 서버마다 균등하게 요청을 분배한다. 단순히 순서에 따라 세션을 할당하므로 경우에 따라 경로별로 같은 처리량이 보장이 되지 않는다.
- 가중치 및 비율 할당 방식 (Weighted Round Robin Scheduling)
  - 라운드 로빈 방식으로 분배하지만, 서버의 가중치에 따라 요청을 더 분배하기도, 덜 분배하기도 한다.
  - 서버 가중치는 사용자가 지정할 수 있고 동적으로 조정되기도 한다.
  - 특정 서버의 성능이 월등히 뛰어나다면 해당 서버에게 높은 가중치를 설정한다.
- **최소 연결 (Least Connections)**
  - 연결 개수가 가장 적은 서버 선택 (트래픽으로 인해 세션이 길어지는 경우 권장)
  - **가장 많이 사용되는 방식**
- 응답 시간 (Fastest Response Time)
  - 가장 빠른 응답 시간을 보내는 서버로 트래픽을 보내주는 방식
  - 서버들의 가용 가능한 리소스와 성능. 그리고 처리 중인 데이터 등이 다를 경우 적합한 방식이다.
- 해시 기반 (Source Hash Scheduling)
  - 사용자의 IP를 해싱한 후 그 결과에 따라 서버로 요청을 분배
  - 특정 클라이언트를 항상 특정 서버로만 할당시키는 방식이다.
- 대역폭 (Bandwidth) 기반
  - 서버들과의 대역폭을 고려하여 트래픽을 분산하는 방식이다.

### L7 로드밸런서

- URL 스위칭 방식 (URL Switching)
  - 특정 하위 URL들은 특정 서버로 처리하는 방식
  - 예를 들어, ‘.../images’ 또는 ‘.../video’와 같은 URL은 서버가 아닌 별도의 스토리지에 있는 객체 데이터로 바로 연결되도록 구성할 수 있다.
- 컨텍스트 스위칭 방식 (Context Switching)
  - 클라이언트가 요청한 특정 리소스에 따라 특정 서버로 연결
  - 예를 들어, 이미지 파일에 대해서는 확장자를 참조해 별도로 구성된 이미지 파일이 있는 서버 또는 스토리지로 직접 연결해줄 수 있다.
- 쿠키 지속성 (Persistence with Cookies)
  - 쿠키 정보를 바탕으로 클라이언트가 연결했었던 서버에 계속 할당해주는 방식이다.

### **로드 밸런서 장애 대비**

서버를 분배하는 로드 밸런서에 문제가 생길 수 있기 때문에 로드 밸런서를 이중화하여 대비한다.

![Untitled](https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5a97bec6-5f84-4a68-bb14-7fb518db9103%2FUntitled.png?table=block&id=b72906c3-da64-4339-8b48-2680fc3281a6&spaceId=ae7599b2-a6a0-4ad1-9149-e9ef3a1ab56c&width=1930&userId=1283b1b0-5fc9-41f0-9b53-56b46ea4c788&cache=v2)

로드밸런서에 장애가 발생했을 시의 시나리오는 다음과 같다.

- 이중화된 로드밸런서들은 서로 상태 확인(Health Check)을 한다.
- Master 서버에 Fail 되면 Standby 서버가 자동으로 Master 서버의 역할을 한다.
- Standby 서버는 평상시에는 대기상태로만 있다가 Master 서버가 Fail 되었을 경우에만 작동을 한다.
- 이 구성을 Fail Over라 한다.

![https://user-images.githubusercontent.com/55661631/145209146-0468a80d-c4dc-49a2-9919-be9e88cbb6aa.png](https://user-images.githubusercontent.com/55661631/145209146-0468a80d-c4dc-49a2-9919-be9e88cbb6aa.png)

### 질문
- **대규모 트래픽에 대처할 수 있는 방법**
  - A. 서버의 성능을 높이는 Scale-up과 분산 처리를 위해 여러 대의 서버를 두는 Scale-out이 있습니다. Scale-up 방식의 경우 한계가 있으므로 주로 Scale-out 방식을 사용합니다. Scale-out 방식에서 분산 처리를 하기위해 로드밸런싱 기술을 사용합니다.
- 로드밸런서가 장애를 대비하는 방법
  - A. 로드밸런서는 갑작스로운 장애에 대비해 이중화를 기본으로 구성합니다. 이중화된 로드밸런서들은 서로의 상태를 확인하며 장애가 발생하면 정상적으로 작동하는 로드밸런서로 교체됩니다.
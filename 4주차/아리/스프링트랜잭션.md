# 스프링 트랜잭션

## 트랜잭션 동기화

- 트랜잭션을 시작하기 위한 Connection 객체를 저장소에 보관해뒀다가 필요할 때 마다 꺼내쓸 수 있다.
- 스레드마다 Connection객체가 독립적으로 관리되기 때문에 멀티스레드 환경에서도 충돌이 발생하지 않는다.

## 트랜잭션 추상화

- 트랜잭션 기술 중에서 공통점을 담은 기술을 추상화하여 제공한다. → PlatformTransactionManager
- PlatformTransactionManager에 각 기술 맞는 TransactionManager를 주입함으로써 종속적이지 않게, 일관된 방식으로 트랜잭션을 처리할 수 있다.
- JDBC → DataSourceTransactionManager
- Hibernate → HibernateTransactionManager
- JPA → JpaTransactionManager

## AOP를 이용한 트랜잭션 분리

- @Transactional을 활용하면 AOP를 통해 트랜잭션 처리를 위한 코드를 클래스에서 분리하여 별도의 모듈로 만들 수 있다.
- 이로 인해 클래스 내에는 핵심 비즈니스 로직만 남길 수 있다!
- AOP는 어떻게 분리할까? target이 상속하고 있는 인터페이스 혹은 target 객체를 상속한 proxy객체 생성. proxy 객체의 메소드를 호출하면 target메서드 전후로 트랜잭션 처리 수행
- → 상속이 불가능한 private 메소드의 경우 적용 불가능
- → target 객체가 내부 메서드를 호출하면 해당 메서드에 대해서는 적용 불가능

## 전파 옵션

: 트랜잭션 동작 도중 다른 트랜잭션을 호출할 때 어떻게 호출할지를 선택

- REQUIRED
    - 부모 트랜잭션 내에서 실행, 없다면 새로운 트랜잭션 생성
    - 전파 옵션의 기본값!
- REQUIRES_NEW
    - 부모 트랜잭션 무시. 무조건 새로운 트랜잭션 생성!
    - 이미 진행중인 트랜잭션이 있다면 보류
- MANDATORY
    - 이미 시작된 트랜잭션이 있다면 참여, 없다면 예외 발생
    - 독립적으로 트랜잭션을 진행하면 안되는 경우 사용
- NESTED
    - 이미 진행중인 트랜잭션이 있다면 중첩으로 (해당 트랜잭션 안에 다시 트랜잭션을 만듦) 진행
    - 중첩된 트랜잭션의 커밋, 롤백은 부모 트랜잭션에게 아무 영향이 없다.
    - 부모 트랜잭션이 롤백되면 중첩된 트랜잭션도 롤백된다.
    - ex) 로그를 저장해야하는 경우 로그 저장작업이 실패한다고 부모 트랜잭션까지 롤백되면 절대 안되지만, 부모 트랜잭션이 롤백되면 로그작업도 롤백되어야 한다.
- SUPPORTS
    - 이미 시작된 트랜잭션이 있다면 참여, 없다면 트랜잭션 없이 진행
- NOT_SUPPORTED
    - 트랜잭션 자체를 무시하여 트랜잭션 없이 진행
    - 이미 진행중인 트랜잭션이 있다면 보류
    - 임의의 메소드 하나에만 트랜잭션을 적용하지 않는 경우 사용
- NEVER
    - 트랜잭션을 사용하지 않도록 강제
    - 이미 진행중인 트랜잭션이 있다면 예외 발생

## readOnly 속성

- 트랜잭션을 읽기 전용으로 설정한다. → insert, update, delete 등의 작업이 진행되면 예외가 발생한다.
- 성능 향상, 특정 트랜잭션에서의 쓰기 작업 방지 등을 위해 이용할 수 있다.
- 일부 트랜잭션 매니저는 이 속성을 무시하기도 한다.

## 트랜잭션 롤백 예외

- 선언적 트랜잭션에서는 런타임 예외가 발생하면 롤백하고, 예외가 발생하지 않거나 checked 예외가 발생하면 커밋한다.
- checked 예외가 발생해도 커밋하는 이유 : checked 예외는 예외적인 상황보다는 return 값 대신 비즈니스적 의미를 담은 결과를 전달하는 용도로 많이 사용하기 때문.
- 런타임 예외만 롤백하는 이유 : 스프링에서 데이터 접근 관련 예외는 모두 런타임 예외로 전환되기 때문
- 이러한 예외 처리를 속성을 통해 커스터마이징 할 수 도 있다.
    - rollbackFor : 특정 예외가 발생시 강제 rollback
    - noRollbackFor : 특정 예외 발생시에도 rollback되지 않음
